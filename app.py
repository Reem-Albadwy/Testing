# âœ… Ù…ÙƒØªØ¨Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
import streamlit as st
import numpy as np
import tensorflow as tf
from tensorflow.keras.preprocessing import image
from PIL import Image
import os, io, base64
from datetime import datetime
from reportlab.lib.pagesizes import letter
from reportlab.platypus import Paragraph, SimpleDocTemplate, Spacer, Image as RLImage
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.enums import TA_CENTER
from reportlab.lib import colors

# âœ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…Ø®ØµØµØ©
def set_background(image_path):
    with open(image_path, "rb") as file:
        encoded = base64.b64encode(file.read()).decode()
    css = f"""
    <style>
    .stApp {{
        background-image: url("data:image/png;base64,{encoded}");
        background-size: cover;
        background-attachment: fixed;
        background-position: center;
    }}
    </style>
    """
    st.markdown(css, unsafe_allow_html=True)

set_background("background.png")  # Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© Ù…Ø¹ Ø§Ù„Ø±ÙŠØ¨Ùˆ

# âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„
@st.cache_resource
def load_model():
    model_path = "SavedModel_format"
    return tf.saved_model.load(model_path)

model = load_model()
infer = model.signatures["serving_default"]

# âœ… Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙƒÙ„Ø§Ø³Ø§Øª ÙˆØ§Ù„ÙˆØµÙ
class_names = ['CaS', 'CoS', 'Gum', 'MC', 'OC', 'OLP', 'OT']
disease_info = {
    "OLP": "Oral Lichen Planus is a chronic condition affecting the mouth.",
    "MC": "Mucosal condition often related to irritation or trauma.",
    "Gum": "Gum disease involves inflammation that affects the tissues around teeth.",
    "CoS": "Condition of soft tissues, sometimes caused by infection.",
    "OT": "Other minor oral tissue issues.",
    "CaS": "Caries symptoms are related to tooth decay and infection.",
    "OC": "Oral cancer may develop in any part of the mouth."
}

# âœ… Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ø¬Ù‡Ø© Streamlit
st.set_page_config(page_title="Teeth Classifier", page_icon="ğŸ¦·")
st.markdown("""
<h1 style='text-align:center; color:#004080; font-family:sans-serif;'>ğŸ¦· Smart Teeth Disease Classifier</h1>
<p style='text-align:center; color:#333;'>Upload a teeth image below to predict the disease and download a detailed PDF report.</p>
""", unsafe_allow_html=True)

# âœ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶
patient_name = st.text_input("ğŸ‘¤ Enter patient name:")

# âœ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
uploaded_file = st.file_uploader("ğŸ“¸ Upload Image", type=["jpg", "jpeg", "png"])

if uploaded_file and patient_name:
    img = Image.open(uploaded_file).convert("RGB")
    st.image(img, caption="Uploaded Image", use_column_width=True)
    img_resized = img.resize((224, 224))
    img_array = image.img_to_array(img_resized) / 255.0
    img_array = np.expand_dims(img_array, axis=0).astype(np.float32)

    predictions = infer(tf.convert_to_tensor(img_array))
    probs = list(predictions.values())[0].numpy()[0]

    pred_class = class_names[np.argmax(probs)]
    confidence = float(np.max(probs)) * 100

    st.success(f"ğŸ©º Prediction: {pred_class}")
    st.info(f"Confidence: {confidence:.2f}%")

    with st.expander("ğŸ§¾ Learn more"):
        st.write(f"**{pred_class}**: {disease_info.get(pred_class)}")
        search_url = f"https://www.google.com/search?q=oral+disease+{pred_class}"
        st.markdown(f"[ğŸ” Search about this condition]({search_url})")

    # âœ… ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± PDF Ø¨ØªÙ†Ø³ÙŠÙ‚ Ø¬Ù…ÙŠÙ„
    def create_report(name, pred, conf, desc):
        buffer = io.BytesIO()
        doc = SimpleDocTemplate(buffer, pagesize=letter)
        styles = getSampleStyleSheet()
        custom_title = ParagraphStyle(name='CenterTitle', fontSize=20, textColor=colors.HexColor('#004080'), alignment=TA_CENTER)
        normal = styles['Normal']
        normal.fontName = 'Helvetica'
        normal.fontSize = 12

        elements = [
            Paragraph("Teeth Disease Diagnostic Report", custom_title),
            Spacer(1, 20),
            Paragraph(f"ğŸ‘¤ <b>Patient Name:</b> {name}", normal),
            Paragraph(f"ğŸ“… <b>Date:</b> {datetime.now().strftime('%Y-%m-%d %H:%M')}", normal),
            Spacer(1, 12),
            Paragraph(f"ğŸ©º <b>Prediction:</b> <font color='red'>{pred}</font>", normal),
            Paragraph(f"ğŸ“Š <b>Confidence:</b> {conf:.2f}%", normal),
            Spacer(1, 12),
            Paragraph(f"ğŸ§¾ <b>Description:</b> {desc}", normal),
            Spacer(1, 20),
            Paragraph("<font size=9 color=gray>This report was auto-generated by an AI-powered diagnosis tool.</font>", normal)
        ]
        doc.build(elements)
        buffer.seek(0)
        return buffer

    pdf_buffer = create_report(patient_name, pred_class, confidence, disease_info[pred_class])

    st.download_button("â¬‡ï¸ Download PDF Report", data=pdf_buffer, file_name="teeth_report.pdf", mime="application/pdf")
